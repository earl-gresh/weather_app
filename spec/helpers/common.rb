RSpec.shared_context 'common' do
  include CustomLogger

  let(:locale1) do
    {
      street: '1 Main Street',
      city: 'San Francisco',
      state: 'CA',
      zipcode: '94105'
    }
  end

  let(:period) { mocked_forecast_response.periods.first }
  let(:street_address) { StreetAddress.new(**locale1) }

  def empty_forecast_cache
    ForecastCache.instance_eval do
      @cache.clear
    end
  end
  
  def mocked_geocode_response
    response = double('mocked_geocode_response')

    lat = JSON.parse(raw_geocode_body).first['lat'].to_f.round(4).to_s
    lon = JSON.parse(raw_geocode_body).first['lon'].to_f.round(4).to_s

    allow(response).to receive(:code_type).and_return(Net::HTTPOK)
    allow(response).to receive(:body).and_return(raw_geocode_body)
    allow(response).to receive(:lat).and_return(lat)
    allow(response).to receive(:lon).and_return(lon)

    response
  end

  def mocked_metadata_response
    response = double('mocked_metadata_response')

    forecast_url = JSON.parse(raw_metadata_body).dig('properties', 'forecast')

    allow(response).to receive(:code_type).and_return(Net::HTTPOK)
    allow(response).to receive(:body).and_return(raw_metadata_body)
    allow(response).to receive(:forecast_url).and_return(forecast_url)

    response
  end

  def mocked_forecast_response
    response = double('mocked_forecast_response')

    periods = JSON.parse(raw_forecast_body).dig('properties', 'periods')

    allow(response).to receive(:code_type).and_return(Net::HTTPOK)
    allow(response).to receive(:body).and_return(raw_forecast_body)
    allow(response).to receive(:periods).and_return(periods)

    response
  end

  def raw_forecast_body
    "{\n    \"@context\": [\n        \"https://geojson.org/geojson-ld/geojson-context.jsonld\",\n        {\n            \"@version\": \"1.1\",\n            \"wx\": \"https://api.weather.gov/ontology#\",\n            \"geo\": \"http://www.opengis.net/ont/geosparql#\",\n            \"unit\": \"http://codes.wmo.int/common/unit/\",\n            \"@vocab\": \"https://api.weather.gov/ontology#\"\n        }\n    ],\n    \"type\": \"Feature\",\n    \"geometry\": {\n        \"type\": \"Polygon\",\n        \"coordinates\": [\n            [\n                [\n                    -122.3712,\n                    37.790199999999999\n                ],\n                [\n                    -122.3768,\n                    37.811999999999998\n                ],\n                [\n                    -122.40440000000001,\n                    37.807499999999997\n                ],\n                [\n                    -122.39880000000001,\n                    37.785699999999999\n                ],\n                [\n                    -122.3712,\n                    37.790199999999999\n                ]\n            ]\n        ]\n    },\n    \"properties\": {\n        \"units\": \"us\",\n        \"forecastGenerator\": \"BaselineForecastGenerator\",\n        \"generatedAt\": \"2024-12-15T22:47:09+00:00\",\n        \"updateTime\": \"2024-12-15T20:26:35+00:00\",\n        \"validTimes\": \"2024-12-15T14:00:00+00:00/P7DT14H\",\n        \"elevation\": {\n            \"unitCode\": \"wmoUnit:m\",\n            \"value\": 0.91439999999999999\n        },\n        \"periods\": [\n            {\n                \"number\": 1,\n                \"name\": \"This Afternoon\",\n                \"startTime\": \"2024-12-15T14:00:00-08:00\",\n                \"endTime\": \"2024-12-15T18:00:00-08:00\",\n                \"isDaytime\": true,\n                \"temperature\": 53,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"6 mph\",\n                \"windDirection\": \"NE\",\n                \"icon\": \"https://api.weather.gov/icons/land/day/sct?size=medium\",\n                \"shortForecast\": \"Mostly Sunny\",\n                \"detailedForecast\": \"Mostly sunny, with a high near 53. Northeast wind around 6 mph.\"\n            },\n            {\n                \"number\": 2,\n                \"name\": \"Tonight\",\n                \"startTime\": \"2024-12-15T18:00:00-08:00\",\n                \"endTime\": \"2024-12-16T06:00:00-08:00\",\n                \"isDaytime\": false,\n                \"temperature\": 50,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": 90\n                },\n                \"windSpeed\": \"3 to 7 mph\",\n                \"windDirection\": \"SE\",\n                \"icon\": \"https://api.weather.gov/icons/land/night/rain,20/rain,90?size=medium\",\n                \"shortForecast\": \"Rain\",\n                \"detailedForecast\": \"Rain after 10pm. Mostly cloudy, with a low around 50. Southeast wind 3 to 7 mph. Chance of precipitation is 90%. New rainfall amounts between a tenth and quarter of an inch possible.\"\n            },\n            {\n                \"number\": 3,\n                \"name\": \"Monday\",\n                \"startTime\": \"2024-12-16T06:00:00-08:00\",\n                \"endTime\": \"2024-12-16T18:00:00-08:00\",\n                \"isDaytime\": true,\n                \"temperature\": 54,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": 100\n                },\n                \"windSpeed\": \"7 to 10 mph\",\n                \"windDirection\": \"SSE\",\n                \"icon\": \"https://api.weather.gov/icons/land/day/rain,100?size=medium\",\n                \"shortForecast\": \"Rain\",\n                \"detailedForecast\": \"Rain. Cloudy, with a high near 54. South southeast wind 7 to 10 mph. Chance of precipitation is 100%. New rainfall amounts between a quarter and half of an inch possible.\"\n            },\n            {\n                \"number\": 4,\n                \"name\": \"Monday Night\",\n                \"startTime\": \"2024-12-16T18:00:00-08:00\",\n                \"endTime\": \"2024-12-17T06:00:00-08:00\",\n                \"isDaytime\": false,\n                \"temperature\": 51,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": 40\n                },\n                \"windSpeed\": \"3 to 8 mph\",\n                \"windDirection\": \"SSE\",\n                \"icon\": \"https://api.weather.gov/icons/land/night/rain,40/rain,20?size=medium\",\n                \"shortForecast\": \"Chance Light Rain\",\n                \"detailedForecast\": \"A chance of rain before 4am. Mostly cloudy, with a low around 51. South southeast wind 3 to 8 mph. Chance of precipitation is 40%.\"\n            },\n            {\n                \"number\": 5,\n                \"name\": \"Tuesday\",\n                \"startTime\": \"2024-12-17T06:00:00-08:00\",\n                \"endTime\": \"2024-12-17T18:00:00-08:00\",\n                \"isDaytime\": true,\n                \"temperature\": 56,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"6 mph\",\n                \"windDirection\": \"N\",\n                \"icon\": \"https://api.weather.gov/icons/land/day/sct?size=medium\",\n                \"shortForecast\": \"Mostly Sunny\",\n                \"detailedForecast\": \"Mostly sunny, with a high near 56. North wind around 6 mph.\"\n            },\n            {\n                \"number\": 6,\n                \"name\": \"Tuesday Night\",\n                \"startTime\": \"2024-12-17T18:00:00-08:00\",\n                \"endTime\": \"2024-12-18T06:00:00-08:00\",\n                \"isDaytime\": false,\n                \"temperature\": 50,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"6 mph\",\n                \"windDirection\": \"N\",\n                \"icon\": \"https://api.weather.gov/icons/land/night/sct?size=medium\",\n                \"shortForecast\": \"Partly Cloudy\",\n                \"detailedForecast\": \"Partly cloudy, with a low around 50.\"\n            },\n            {\n                \"number\": 7,\n                \"name\": \"Wednesday\",\n                \"startTime\": \"2024-12-18T06:00:00-08:00\",\n                \"endTime\": \"2024-12-18T18:00:00-08:00\",\n                \"isDaytime\": true,\n                \"temperature\": 57,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"3 to 7 mph\",\n                \"windDirection\": \"NE\",\n                \"icon\": \"https://api.weather.gov/icons/land/day/sct?size=medium\",\n                \"shortForecast\": \"Mostly Sunny\",\n                \"detailedForecast\": \"Mostly sunny, with a high near 57.\"\n            },\n            {\n                \"number\": 8,\n                \"name\": \"Wednesday Night\",\n                \"startTime\": \"2024-12-18T18:00:00-08:00\",\n                \"endTime\": \"2024-12-19T06:00:00-08:00\",\n                \"isDaytime\": false,\n                \"temperature\": 49,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"7 mph\",\n                \"windDirection\": \"NE\",\n                \"icon\": \"https://api.weather.gov/icons/land/night/sct?size=medium\",\n                \"shortForecast\": \"Partly Cloudy\",\n                \"detailedForecast\": \"Partly cloudy, with a low around 49.\"\n            },\n            {\n                \"number\": 9,\n                \"name\": \"Thursday\",\n                \"startTime\": \"2024-12-19T06:00:00-08:00\",\n                \"endTime\": \"2024-12-19T18:00:00-08:00\",\n                \"isDaytime\": true,\n                \"temperature\": 57,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"7 mph\",\n                \"windDirection\": \"NE\",\n                \"icon\": \"https://api.weather.gov/icons/land/day/sct?size=medium\",\n                \"shortForecast\": \"Mostly Sunny\",\n                \"detailedForecast\": \"Mostly sunny, with a high near 57.\"\n            },\n            {\n                \"number\": 10,\n                \"name\": \"Thursday Night\",\n                \"startTime\": \"2024-12-19T18:00:00-08:00\",\n                \"endTime\": \"2024-12-20T06:00:00-08:00\",\n                \"isDaytime\": false,\n                \"temperature\": 50,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"7 mph\",\n                \"windDirection\": \"ENE\",\n                \"icon\": \"https://api.weather.gov/icons/land/night/sct?size=medium\",\n                \"shortForecast\": \"Partly Cloudy\",\n                \"detailedForecast\": \"Partly cloudy, with a low around 50.\"\n            },\n            {\n                \"number\": 11,\n                \"name\": \"Friday\",\n                \"startTime\": \"2024-12-20T06:00:00-08:00\",\n                \"endTime\": \"2024-12-20T18:00:00-08:00\",\n                \"isDaytime\": true,\n                \"temperature\": 59,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"8 mph\",\n                \"windDirection\": \"E\",\n                \"icon\": \"https://api.weather.gov/icons/land/day/bkn/rain?size=medium\",\n                \"shortForecast\": \"Partly Sunny then Slight Chance Light Rain\",\n                \"detailedForecast\": \"A slight chance of rain after 4pm. Partly sunny, with a high near 59.\"\n            },\n            {\n                \"number\": 12,\n                \"name\": \"Friday Night\",\n                \"startTime\": \"2024-12-20T18:00:00-08:00\",\n                \"endTime\": \"2024-12-21T06:00:00-08:00\",\n                \"isDaytime\": false,\n                \"temperature\": 55,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"7 to 10 mph\",\n                \"windDirection\": \"SE\",\n                \"icon\": \"https://api.weather.gov/icons/land/night/rain?size=medium\",\n                \"shortForecast\": \"Rain Likely\",\n                \"detailedForecast\": \"Rain likely. Mostly cloudy, with a low around 55.\"\n            },\n            {\n                \"number\": 13,\n                \"name\": \"Saturday\",\n                \"startTime\": \"2024-12-21T06:00:00-08:00\",\n                \"endTime\": \"2024-12-21T18:00:00-08:00\",\n                \"isDaytime\": true,\n                \"temperature\": 58,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"7 to 10 mph\",\n                \"windDirection\": \"S\",\n                \"icon\": \"https://api.weather.gov/icons/land/day/rain?size=medium\",\n                \"shortForecast\": \"Rain Likely\",\n                \"detailedForecast\": \"Rain likely. Mostly cloudy, with a high near 58.\"\n            },\n            {\n                \"number\": 14,\n                \"name\": \"Saturday Night\",\n                \"startTime\": \"2024-12-21T18:00:00-08:00\",\n                \"endTime\": \"2024-12-22T06:00:00-08:00\",\n                \"isDaytime\": false,\n                \"temperature\": 54,\n                \"temperatureUnit\": \"F\",\n                \"temperatureTrend\": \"\",\n                \"probabilityOfPrecipitation\": {\n                    \"unitCode\": \"wmoUnit:percent\",\n                    \"value\": null\n                },\n                \"windSpeed\": \"3 to 7 mph\",\n                \"windDirection\": \"SSE\",\n                \"icon\": \"https://api.weather.gov/icons/land/night/rain?size=medium\",\n                \"shortForecast\": \"Chance Light Rain\",\n                \"detailedForecast\": \"A chance of rain. Mostly cloudy, with a low around 54.\"\n            }\n        ]\n    }\n}"
  end

  def raw_metadata_body
    "{\n    \"@context\": [\n        \"https://geojson.org/geojson-ld/geojson-context.jsonld\",\n        {\n            \"@version\": \"1.1\",\n            \"wx\": \"https://api.weather.gov/ontology#\",\n            \"s\": \"https://schema.org/\",\n            \"geo\": \"http://www.opengis.net/ont/geosparql#\",\n            \"unit\": \"http://codes.wmo.int/common/unit/\",\n            \"@vocab\": \"https://api.weather.gov/ontology#\",\n            \"geometry\": {\n                \"@id\": \"s:GeoCoordinates\",\n                \"@type\": \"geo:wktLiteral\"\n            },\n            \"city\": \"s:addressLocality\",\n            \"state\": \"s:addressRegion\",\n            \"distance\": {\n                \"@id\": \"s:Distance\",\n                \"@type\": \"s:QuantitativeValue\"\n            },\n            \"bearing\": {\n                \"@type\": \"s:QuantitativeValue\"\n            },\n            \"value\": {\n                \"@id\": \"s:value\"\n            },\n            \"unitCode\": {\n                \"@id\": \"s:unitCode\",\n                \"@type\": \"@id\"\n            },\n            \"forecastOffice\": {\n                \"@type\": \"@id\"\n            },\n            \"forecastGridData\": {\n                \"@type\": \"@id\"\n            },\n            \"publicZone\": {\n                \"@type\": \"@id\"\n            },\n            \"county\": {\n                \"@type\": \"@id\"\n            }\n        }\n    ],\n    \"id\": \"https://api.weather.gov/points/37.7888,-122.3911\",\n    \"type\": \"Feature\",\n    \"geometry\": {\n        \"type\": \"Point\",\n        \"coordinates\": [\n            -122.39109999999999,\n            37.788800000000002\n        ]\n    },\n    \"properties\": {\n        \"@id\": \"https://api.weather.gov/points/37.7888,-122.3911\",\n        \"@type\": \"wx:Point\",\n        \"cwa\": \"MTR\",\n        \"forecastOffice\": \"https://api.weather.gov/offices/MTR\",\n        \"gridId\": \"MTR\",\n        \"gridX\": 86,\n        \"gridY\": 106,\n        \"forecast\": \"https://api.weather.gov/gridpoints/MTR/86,106/forecast\",\n        \"forecastHourly\": \"https://api.weather.gov/gridpoints/MTR/86,106/forecast/hourly\",\n        \"forecastGridData\": \"https://api.weather.gov/gridpoints/MTR/86,106\",\n        \"observationStations\": \"https://api.weather.gov/gridpoints/MTR/86,106/stations\",\n        \"relativeLocation\": {\n            \"type\": \"Feature\",\n            \"geometry\": {\n                \"type\": \"Point\",\n                \"coordinates\": [\n                    -122.298964,\n                    37.839906900000003\n                ]\n            },\n            \"properties\": {\n                \"city\": \"Emeryville\",\n                \"state\": \"CA\",\n                \"distance\": {\n                    \"unitCode\": \"wmoUnit:m\",\n                    \"value\": 9889.4538371730996\n                },\n                \"bearing\": {\n                    \"unitCode\": \"wmoUnit:degree_(angle)\",\n                    \"value\": 234\n                }\n            }\n        },\n        \"forecastZone\": \"https://api.weather.gov/zones/forecast/CAZ006\",\n        \"county\": \"https://api.weather.gov/zones/county/CAC075\",\n        \"fireWeatherZone\": \"https://api.weather.gov/zones/fire/CAZ006\",\n        \"timeZone\": \"America/Los_Angeles\",\n        \"radarStation\": \"KMUX\"\n    }\n}"
  end

  def raw_geocode_body
    "[{\"place_id\":310733457,\"licence\":\"Data \xC2\xA9 OpenStreetMap contributors, ODbL 1.0. https://osm.org/copyright\",\"osm_type\":\"way\",\"osm_id\":12003951,\"boundingbox\":[\"41.079908\",\"41.093458\",\"-76.872491\",\"-76.858419\"],\"lat\":\"41.086509\",\"lon\":\"-76.865676\",\"display_name\":\"Main Street, Watsontown, Northumberland County, Pennsylvania, 17777, United States\",\"class\":\"highway\",\"type\":\"secondary\",\"importance\":0.6100099999999999}]"
  end

  # To view the content of the raw body text in a readable context, these three helpers are available
  def raw_geocode_body_parsed
    JSON.parse(raw_geocode_body)
  end

  def raw_metadata_body_parsed
    JSON.parse(raw_metadata_body)
  end

  def raw_forecast_body_parsed
    JSON.parse(raw_forecast_body)
  end
end
